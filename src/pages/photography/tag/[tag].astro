---
import PhotoLayout from "../../../layouts/PhotoLayout.astro";
import {
  getAlbumTitleMap,
  getPhotosWithExif,
  sortPhotos,
  extractTags,
  extractTagNames,
  serializePhotoForGallery,
  mapToLightboxPhotos
} from "../../../utils/photo-helpers";
import PhotoLightbox from "../../../components/photo/PhotoLightbox.astro";
import { FilteredPhotoGallery } from "../../../components/react/FilteredPhotoGallery";
import TagFilterBar from "../../../components/photo/TagFilterBar.astro";

export async function getStaticPaths() {
  const allPhotos = await getPhotosWithExif();

  // Collect all unique tags (preserving original casing for URLs)
  const tagsWithDisplay = extractTags(allPhotos, { preserveDisplayCasing: true });

  // Return paths for each unique tag (Astro handles URL encoding automatically)
  return tagsWithDisplay.map(({ displayTag }) => ({
    params: { tag: displayTag },
  }));
}

const { tag } = Astro.params;
const decodedTag = decodeURIComponent(tag || "");

const albumTitleMap = await getAlbumTitleMap();

const allPhotos = sortPhotos(await getPhotosWithExif());
const galleryPhotos = allPhotos.map(photo => serializePhotoForGallery(photo, albumTitleMap));

// Get all unique tags for the filter pills (sorted alphabetically)
const allTags = extractTagNames(allPhotos, 'alpha');

const filteredPhotos = allPhotos.filter((photo) =>
  photo.data.tags.some((t) => t.toLowerCase() === decodedTag.toLowerCase()),
);
const sortedPhotos = sortPhotos(filteredPhotos);
---

<PhotoLayout
  title={`${decodedTag} Photos`}
  description={`Photos tagged with ${decodedTag}`}
>
  <div class="tag-page">
    <div class="tag-header">
      <h1 class="tag-title">#{decodedTag.toLowerCase()}</h1>
      <p class="tag-count" id="photo-count">
        {sortedPhotos.length}
        {sortedPhotos.length === 1 ? "photo" : "photos"}
      </p>
    </div>

    <TagFilterBar
      tags={allTags}
      photos={galleryPhotos}
      initialActiveTag={decodedTag.toLowerCase()}
    />

    {
      sortedPhotos.length === 0 ? (
        <p class="no-photos">No photos found with this tag.</p>
      ) : (
        <>
          <div class="gallery-container">
            <FilteredPhotoGallery
              client:load
            allPhotos={galleryPhotos}
              initialActiveTags={[decodedTag.toLowerCase()]}
            />
          </div>
          <PhotoLightbox
          photos={mapToLightboxPhotos(sortedPhotos, albumTitleMap)}
          />
        </>
      )
    }
  </div>

  <style>
    .tag-page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Allow flex child to shrink */
    }

    .tag-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid rgba(28, 25, 23, 0.1);
    }

    .tag-title {
      font-family: "Crimson Text", serif;
      font-size: 3.5rem;
      font-weight: 700;
      color: var(--charcoal);
      margin: 0 0 0.5rem;
      letter-spacing: -0.02em;
    }

    .tag-count {
      color: var(--gray);
      font-size: 1rem;
      font-weight: 400;
    }

    .no-photos {
      text-align: center;
      color: var(--gray);
      font-size: 1.125rem;
      padding: 4rem 2rem;
    }

    @media (max-width: 768px) {
      .tag-page {
        padding: 1.5rem 1rem;
      }

      .tag-title {
        font-size: 2.5rem;
      }

      .tag-filter-bar {
        padding: 1rem;
        margin-bottom: 2rem;
      }

      .tag-filter-controls {
        justify-content: center;
      }

      .tag-pills {
        gap: 0.5rem;
      }

      .tag-pill {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
      }
    }
  </style>

  <script>
    import { setupLightboxSync } from "../../../utils/client/lightbox-sync";

    setupLightboxSync({
      onFilteredPhotosChange: (filteredPhotos) => {
        const photoCount = document.getElementById('photo-count');
        if (photoCount) {
          const count = filteredPhotos.length;
          photoCount.textContent = `${count} ${count === 1 ? 'photo' : 'photos'}`;
        }
      },
      onActiveTagsChange: (activeTags) => {
        const tagTitle = document.querySelector('.tag-title');
        if (!tagTitle) return;

        if (activeTags.length > 1) {
          const sortedTags = [...activeTags].sort();
          tagTitle.textContent = sortedTags.map((t) => `#${t}`).join(' + ');
        } else if (activeTags.length === 1) {
          tagTitle.textContent = `#${activeTags[0]}`;
        }
      },
    });
  </script>
</PhotoLayout>
