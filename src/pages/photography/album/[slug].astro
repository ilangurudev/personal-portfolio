---
import PhotoLayout from '../../../layouts/PhotoLayout.astro';
import { getCollection, getEntry } from 'astro:content';
import {
  getAlbumPhotosWithExif,
  getAlbumTitleMap,
  sortPhotos,
  extractTagNames,
  serializePhotoForGallery,
  mapToLightboxPhotos
} from '../../../utils/photo-helpers';
import PhotoLightbox from '../../../components/photo/PhotoLightbox.astro';
import PhotoIcons from '../../../components/photo/PhotoIcons.astro';
import { FilteredPhotoGallery } from '../../../components/react/FilteredPhotoGallery';
import TagFilterBar from '../../../components/photo/TagFilterBar.astro';

export async function getStaticPaths() {
  const albums = await getCollection('albums');
  return albums.map((album) => ({
    params: { slug: album.slug },
  }));
}

const { slug } = Astro.params;
const album = await getEntry('albums', slug!);
const photos = await getAlbumPhotosWithExif(slug!);
const sortedPhotos = sortPhotos(photos);

// Get all unique tags from this album's photos only (sorted alphabetically)
const albumTags = extractTagNames(photos, 'alpha');
const albumTitleMap = await getAlbumTitleMap([album]);

// Map to serializable structure for client component
const galleryPhotos = sortedPhotos.map(p => serializePhotoForGallery(
  { ...p, data: { ...p.data, albumTitle: album.data.title } },
  albumTitleMap
));
---

<PhotoLayout title={album.data.title} description={album.data.description}>
  <PhotoIcons />
  <div class="album-page">
    <div class="album-header">
      <h1 class="album-title">{album.data.title}</h1>
      <p class="album-description">{album.data.description}</p>
      <time class="album-date" datetime={album.data.date.toISOString()}>
        {album.data.date.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })}
      </time>
    </div>

    {sortedPhotos.length === 0 ? (
      <p class="no-photos">No photos in this album yet.</p>
    ) : (
      <>
        {albumTags.length > 0 && (
          <TagFilterBar tags={albumTags} photos={galleryPhotos} />
        )}
        <div class="gallery-container">
          <FilteredPhotoGallery 
            client:load
            allPhotos={galleryPhotos}
            initialActiveTags={[]}
          />
        </div>
        <PhotoLightbox photos={mapToLightboxPhotos(sortedPhotos, albumTitleMap)} />
      </>
    )}
  </div>

  <style>
    .album-page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Allow flex child to shrink */
    }

    .album-header {
      text-align: center;
      margin-bottom: 2rem; /* Reduced from 4rem to give more space to gallery */
      padding-bottom: 2rem;
      border-bottom: 1px solid rgba(28, 25, 23, 0.1);
      flex-shrink: 0;
    }

    .album-title {
      font-family: 'Crimson Text', serif;
      font-size: 3.5rem;
      font-weight: 700;
      color: var(--charcoal);
      margin: 0 0 1rem;
      letter-spacing: -0.02em;
    }

    .album-description {
      font-size: 1.25rem;
      color: var(--gray);
      line-height: 1.6;
      margin: 0 0 1rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .album-date {
      color: var(--amber);
      font-size: 1rem;
      font-weight: 500;
    }

    .no-photos {
      text-align: center;
      color: var(--gray);
      font-size: 1.125rem;
      padding: 4rem 2rem;
    }

    @media (max-width: 768px) {
      .album-page {
        padding: 1.5rem 1rem;
      }

      .album-title {
        font-size: 2.5rem;
      }

      .album-description {
        font-size: 1.125rem;
      }

      .tag-filter-controls {
        justify-content: center;
      }

      .tag-pills {
        gap: 0.5rem;
      }

      .tag-pill {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
      }
    }
  </style>

  <script>
    import { setupLightboxSync } from '../../../utils/client/lightbox-sync';
    setupLightboxSync();
  </script>
</PhotoLayout>
