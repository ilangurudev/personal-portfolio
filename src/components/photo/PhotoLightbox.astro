---
import PhotoIcons from './PhotoIcons.astro';
import { getPhotoUrl } from '../../utils/url-helper';

interface Props {
  photos: Array<{
    id: string;
    data: {
      title: string;
      filename: string;
      album?: string;
      albumTitle?: string;
      tags?: string[];
      camera?: string;
      settings?: string;
      focalLength?: number;
      location?: string;
    };
  }>;
  initialIndex?: number;
}

const { photos, initialIndex = 0 } = Astro.props;
---

<PhotoIcons />

<div id="photo-lightbox" class="lightbox" style="display: none;">
  <div class="lightbox-backdrop"></div>
  <div class="shutter-overlay"></div>
  <button class="lightbox-close" aria-label="Close lightbox">×</button>
  
  <div class="lightbox-content">
    <button class="lightbox-nav lightbox-prev" aria-label="Previous photo">‹</button>
    <div class="lightbox-image-container">
      <img class="lightbox-image" src="" alt="" />
      <div class="lightbox-info">
        <div class="lightbox-tags-and-album">
          <div class="lightbox-album"></div>
          <div class="lightbox-tags"></div>
        </div>
        <div class="lightbox-metadata-row">
          <div class="lightbox-metadata"></div>
          <div class="lightbox-counter-controls">
            <div class="lightbox-counter"></div>
            <div class="lightbox-slideshow-container">
              <button class="lightbox-slideshow-btn" aria-label="Slideshow settings" title="Slideshow">
                <svg class="lightbox-slideshow-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="4" y="5" width="16" height="10" rx="1" stroke="currentColor" stroke-width="1.5"/>
                  <path d="M4 6H20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  <path d="M10 15L14 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  <path d="M8 19L16 19" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </button>
              <div class="lightbox-slideshow-dropdown" style="display: none;">
                <button class="slideshow-option" data-interval="0">Off</button>
                <button class="slideshow-option" data-interval="1000">1s</button>
                <button class="slideshow-option" data-interval="3000">3s</button>
                <button class="slideshow-option" data-interval="5000">5s</button>
                <button class="slideshow-option" data-interval="10000">10s</button>
                <button class="slideshow-option" data-interval="60000">60s</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <button class="lightbox-nav lightbox-next" aria-label="Next photo">›</button>
  </div>
</div>

<script>
  const STANDARD_FOCAL_LENGTHS = [10, 14, 16, 18, 20, 24, 28, 35, 40, 50, 60, 70, 100, 120, 150, 180, 200];

  interface Photo {
    id: string;
    url: string;
    data: {
      title: string;
      filename: string;
      album?: string;
      albumTitle?: string;
      tags?: string[];
      camera?: string;
      settings?: string;
      focalLength?: number;
      location?: string;
    };
  }

  class PhotoLightbox {
    private lightbox: HTMLElement | null;
    private image: HTMLImageElement | null;
    private tags: HTMLElement | null;
    private album: HTMLElement | null;
    private metadata: HTMLElement | null;
    private counter: HTMLElement | null;
    public photos: Photo[]; // Made public so it can be accessed for finding indices
    private currentIndex: number;
    private isOpen: boolean = false;
    private touchStartX: number = 0;
    private touchEndX: number = 0;
    private touchStartY: number = 0;
    private touchEndY: number = 0;
    private isSwiping: boolean = false;
    private shutterOverlay: HTMLElement | null;
    private slideshowInterval: number | null = null;
    private slideshowIntervalMs: number = 0;
    private slideshowBtn: HTMLElement | null;
    private slideshowDropdown: HTMLElement | null;
    private isTransitioning: boolean = false;
    private transitionTimeout: number | null = null;
    private imageLoadTimeout: number | null = null;

    constructor(photos: Photo[]) {
      this.photos = photos;
      this.currentIndex = 0;
      this.lightbox = document.getElementById('photo-lightbox');
      this.shutterOverlay = this.lightbox?.querySelector('.shutter-overlay') as HTMLElement;
      this.image = this.lightbox?.querySelector('.lightbox-image') as HTMLImageElement;
      this.tags = this.lightbox?.querySelector('.lightbox-tags') as HTMLElement;
      this.album = this.lightbox?.querySelector('.lightbox-album') as HTMLElement;
      this.metadata = this.lightbox?.querySelector('.lightbox-metadata') as HTMLElement;
      this.counter = this.lightbox?.querySelector('.lightbox-counter') as HTMLElement;
      this.slideshowBtn = this.lightbox?.querySelector('.lightbox-slideshow-btn') as HTMLElement;
      this.slideshowDropdown = this.lightbox?.querySelector('.lightbox-slideshow-dropdown') as HTMLElement;

      this.init();
    }

    private init() {
      if (!this.lightbox) return;

      // Close button
      const closeBtn = this.lightbox.querySelector('.lightbox-close');
      closeBtn?.addEventListener('click', () => this.close());

      // Backdrop click
      const backdrop = this.lightbox.querySelector('.lightbox-backdrop');
      backdrop?.addEventListener('click', () => this.close());

      // Navigation buttons
      const prevBtn = this.lightbox.querySelector('.lightbox-prev');
      const nextBtn = this.lightbox.querySelector('.lightbox-next');
      prevBtn?.addEventListener('click', () => this.prev());
      nextBtn?.addEventListener('click', () => this.next());

      // Keyboard navigation
      document.addEventListener('keydown', (e) => this.handleKeydown(e));

      // Touch navigation for swipe gestures
      const imageContainer = this.lightbox.querySelector('.lightbox-image-container');
      if (imageContainer) {
        imageContainer.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: true });
        imageContainer.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: true });
        imageContainer.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: true });
      }

      // Prevent body scroll when open
      this.lightbox.addEventListener('transitionend', () => {
        if (this.isOpen) {
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = '';
        }
      });

      // Slideshow button
      this.slideshowBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        if (this.slideshowDropdown) {
          const isVisible = this.slideshowDropdown.style.display !== 'none';
          this.slideshowDropdown.style.display = isVisible ? 'none' : 'block';
        }
      });

      // Slideshow dropdown options
      this.slideshowDropdown?.querySelectorAll('.slideshow-option').forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const interval = parseInt((option as HTMLElement).getAttribute('data-interval') || '0');
          this.setSlideshowInterval(interval);
          if (this.slideshowDropdown) {
            this.slideshowDropdown.style.display = 'none';
          }
        });
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (this.isOpen && this.slideshowDropdown && this.slideshowBtn) {
          const target = e.target as HTMLElement;
          if (!this.slideshowDropdown.contains(target) && !this.slideshowBtn.contains(target)) {
            this.slideshowDropdown.style.display = 'none';
          }
        }
      });
    }

    private handleKeydown(e: KeyboardEvent) {
      if (!this.isOpen) return;

      switch (e.key) {
        case 'Escape':
          this.close();
          break;
        case 'ArrowLeft':
          this.prev();
          break;
        case 'ArrowRight':
          this.next();
          break;
      }
    }

    private handleTouchStart(e: TouchEvent) {
      if (!this.isOpen) return;

      this.touchStartX = e.touches[0].clientX;
      this.touchStartY = e.touches[0].clientY;
      this.isSwiping = false;
    }

    private handleTouchMove(e: TouchEvent) {
      if (!this.isOpen) return;

      this.touchEndX = e.touches[0].clientX;
      this.touchEndY = e.touches[0].clientY;

      // Calculate the distance moved
      const deltaX = Math.abs(this.touchEndX - this.touchStartX);
      const deltaY = Math.abs(this.touchEndY - this.touchStartY);

      // If horizontal movement is greater than vertical, it's a swipe
      if (deltaX > deltaY && deltaX > 10) {
        this.isSwiping = true;
      }
    }

    private handleTouchEnd(e: TouchEvent) {
      if (!this.isOpen || !this.isSwiping) return;

      const deltaX = this.touchEndX - this.touchStartX;
      const deltaY = Math.abs(this.touchEndY - this.touchStartY);
      const swipeThreshold = 50; // Minimum distance for a swipe

      // Only trigger navigation if horizontal swipe is greater than vertical movement
      if (Math.abs(deltaX) > swipeThreshold && Math.abs(deltaX) > deltaY) {
        if (deltaX > 0) {
          // Swipe right - go to previous photo
          this.prev();
        } else {
          // Swipe left - go to next photo
          this.next();
        }
      }

      // Reset values
      this.touchStartX = 0;
      this.touchEndX = 0;
      this.touchStartY = 0;
      this.touchEndY = 0;
      this.isSwiping = false;
    }

    public open(index: number) {
      if (index < 0 || index >= this.photos.length) return;
      
      this.currentIndex = index;
      this.isOpen = true;
      this.isTransitioning = false;
      
      if (this.lightbox) {
        this.lightbox.style.display = 'flex';
        // Trigger reflow for animation
        requestAnimationFrame(() => {
          this.lightbox?.classList.add('active');
          
          // Shutter animation
          if (this.shutterOverlay) {
            this.shutterOverlay.style.animation = 'none';
            this.shutterOverlay.offsetHeight; // trigger reflow
            this.shutterOverlay.style.animation = 'shutterClick 0.3s ease-in-out';
          }
          
          // Update image with fade-in for initial open
          this.updateImage();
          if (this.image) {
            this.image.style.opacity = '0';
            requestAnimationFrame(() => {
              this.image!.style.opacity = '1';
            });
          }
        });
      }
    }

    public close() {
      this.isOpen = false;
      this.stopSlideshow();
      if (this.lightbox) {
        this.lightbox.classList.remove('active');
        // Hide after animation
        setTimeout(() => {
          if (this.lightbox && !this.isOpen) {
            this.lightbox.style.display = 'none';
          }
        }, 300);
      }
      document.body.style.overflow = '';
      if (this.slideshowDropdown) {
        this.slideshowDropdown.style.display = 'none';
      }
    }

    public updatePhotos(newPhotos: Photo[]) {
      // Update the photos array
      this.photos = newPhotos;
      
      // If currently open, ensure currentIndex is still valid
      if (this.isOpen && this.currentIndex >= this.photos.length) {
        // If current photo is no longer in the list, close the lightbox
        this.close();
      } else if (this.isOpen) {
        // Update the display to reflect the current photo
        this.updateImage();
      }
    }

    public next() {
      if (this.isTransitioning) return;
      
      // Restart slideshow timer on manual navigation
      if (this.slideshowIntervalMs > 0) {
        this.stopSlideshow();
        this.startSlideshow();
      }
      const nextIndex = (this.currentIndex + 1) % this.photos.length;
      this.navigateTo(nextIndex);
    }

    public prev() {
      if (this.isTransitioning) return;
      
      // Restart slideshow timer on manual navigation
      if (this.slideshowIntervalMs > 0) {
        this.stopSlideshow();
        this.startSlideshow();
      }
      const prevIndex = (this.currentIndex - 1 + this.photos.length) % this.photos.length;
      this.navigateTo(prevIndex);
    }

    private navigateTo(index: number) {
      if (index < 0 || index >= this.photos.length || index === this.currentIndex) return;
      if (!this.isOpen || !this.image) return;
      
      // Clean up any pending transitions
      if (this.transitionTimeout !== null) {
        clearTimeout(this.transitionTimeout);
        this.transitionTimeout = null;
      }
      if (this.imageLoadTimeout !== null) {
        clearTimeout(this.imageLoadTimeout);
        this.imageLoadTimeout = null;
      }
      // Remove previous event listeners
      this.image.onload = null;
      this.image.onerror = null;
      
      this.isTransitioning = true;
      this.currentIndex = index;
      
      // Preload adjacent images for smooth navigation
      this.preloadAdjacent();
      
      // Fade out current image
      this.image.style.opacity = '0';
      
      // Wait for fade-out, then update and fade in
      this.transitionTimeout = window.setTimeout(() => {
        const photo = this.photos[this.currentIndex];
        if (!photo || !this.image) return;
        
        // Update image source
        this.image.src = photo.url;
        this.image.alt = photo.data.title;
        
        // Update metadata
        this.updateImageMetadata();
        
        // Wait for image to load before fading in (with timeout to prevent hanging)
        const fadeInImage = () => {
          requestAnimationFrame(() => {
            if (this.image) {
              this.image.style.opacity = '1';
              // Reset transitioning flag after transition completes
              setTimeout(() => {
                this.isTransitioning = false;
              }, 300);
            }
          });
        };
        
        // If image is already loaded (cached), fade in immediately
        if (this.image.complete && this.image.naturalWidth > 0) {
          fadeInImage();
        } else {
          // Otherwise wait for load, but don't wait more than 200ms
          this.imageLoadTimeout = window.setTimeout(fadeInImage, 200);
          this.image.onload = () => {
            if (this.imageLoadTimeout !== null) {
              clearTimeout(this.imageLoadTimeout);
              this.imageLoadTimeout = null;
            }
            fadeInImage();
          };
          // Handle load errors
          this.image.onerror = () => {
            if (this.imageLoadTimeout !== null) {
              clearTimeout(this.imageLoadTimeout);
              this.imageLoadTimeout = null;
            }
            fadeInImage(); // Still fade in even on error
          };
        }
      }, 150);
    }

    private setSlideshowInterval(intervalMs: number) {
      this.slideshowIntervalMs = intervalMs;
      this.stopSlideshow();
      
      if (intervalMs > 0) {
        this.startSlideshow();
      }
      
      // Update active state in dropdown
      this.slideshowDropdown?.querySelectorAll('.slideshow-option').forEach(option => {
        const optionInterval = parseInt((option as HTMLElement).getAttribute('data-interval') || '0');
        if (optionInterval === intervalMs) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });
    }

    private startSlideshow() {
      if (this.slideshowIntervalMs > 0 && !this.slideshowInterval) {
        this.slideshowInterval = window.setInterval(() => {
          if (this.isOpen) {
            this.next();
          } else {
            this.stopSlideshow();
          }
        }, this.slideshowIntervalMs);
        
        if (this.slideshowBtn) {
          this.slideshowBtn.classList.add('active');
        }
      }
    }

    private stopSlideshow() {
      if (this.slideshowInterval !== null) {
        clearInterval(this.slideshowInterval);
        this.slideshowInterval = null;
      }
      
      if (this.slideshowBtn) {
        this.slideshowBtn.classList.remove('active');
      }
    }

    private updateImage() {
      const photo = this.photos[this.currentIndex];
      if (!photo || !this.image) return;

      // Preload next and previous images
      this.preloadAdjacent();

      // Update current image
      this.image.src = photo.url;
      this.image.alt = photo.data.title;

      // Update metadata
      this.updateImageMetadata();
    }

    private updateImageMetadata() {
      const photo = this.photos[this.currentIndex];
      if (!photo) return;

      // Update tags
      if (this.tags) {
        if (photo.data.tags && Array.isArray(photo.data.tags) && photo.data.tags.length > 0) {
          const tagsHTML = photo.data.tags
            .map(tag => {
              const encodedTag = encodeURIComponent(tag);
              return `<span class="lightbox-tag" data-tag="${encodedTag}" style="display: inline-block; font-size: 0.75rem; color: rgba(255, 251, 245, 0.95); background: rgba(160, 160, 160, 0.6); padding: 0.375rem 0.75rem; border-radius: 14px; font-weight: 400; letter-spacing: 0.02em; cursor: pointer; transition: all 0.2s ease; user-select: none; border: 1px solid rgba(255, 255, 255, 0.2); white-space: nowrap; opacity: 1; visibility: visible;">#${tag.toLowerCase()}</span>`;
            })
            .join('');
          this.tags.innerHTML = tagsHTML;
          this.tags.style.display = 'contents';
          this.tags.style.visibility = 'visible';
          
          // Add click handlers to tags
          setTimeout(() => {
            this.tags?.querySelectorAll('.lightbox-tag').forEach(tagEl => {
              const el = tagEl as HTMLElement;
              el.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                const tag = el.getAttribute('data-tag');
                if (tag) {
                  window.location.href = `/photography/tag/${tag}`;
                }
              });
              el.addEventListener('mouseenter', () => {
                el.style.background = 'rgba(180, 180, 180, 0.8)';
                el.style.color = 'rgba(255, 251, 245, 1)';
                el.style.transform = 'translateY(-1px)';
                el.style.borderColor = 'rgba(255, 255, 255, 0.4)';
              });
              el.addEventListener('mouseleave', () => {
                el.style.background = 'rgba(160, 160, 160, 0.6)';
                el.style.color = 'rgba(255, 251, 245, 0.95)';
                el.style.transform = 'translateY(0)';
                el.style.borderColor = 'rgba(255, 255, 255, 0.2)';
              });
            });
          }, 0);
        } else {
          this.tags.style.display = 'none';
          this.tags.style.visibility = 'hidden';
        }
      }

      // Update album
      if (this.album) {
        if (photo.data.album && photo.data.album.trim()) {
          const folderIcon = this.getIconSVG('icon-folder');
          const albumSlug = photo.data.album;
          // Use album title if available, otherwise format album slug
          const albumDisplay = photo.data.albumTitle || albumSlug.split('-').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1)
          ).join(' ');
          
          this.album.innerHTML = `<span class="lightbox-album-link" data-album="${albumSlug}" style="display: inline-flex; align-items: center; font-size: 0.75rem; color: rgba(255, 251, 245, 0.95); background: rgba(160, 160, 160, 0.6); padding: 0.375rem 0.75rem; border-radius: 14px; font-weight: 400; letter-spacing: 0.02em; cursor: pointer; transition: all 0.2s ease; user-select: none; border: 1px solid rgba(255, 255, 255, 0.2); white-space: nowrap; opacity: 1; visibility: visible; gap: 0.375rem;">${folderIcon}<span>${albumDisplay}</span></span>`;
          this.album.style.display = 'flex';
          this.album.style.visibility = 'visible';
          
          // Add click handler to album
          setTimeout(() => {
            const albumLink = this.album?.querySelector('.lightbox-album-link');
            if (albumLink) {
              const el = albumLink as HTMLElement;
              el.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                const album = el.getAttribute('data-album');
                if (album) {
                  window.location.href = `/photography/album/${album}`;
                }
              });
              el.addEventListener('mouseenter', () => {
                el.style.background = 'rgba(180, 180, 180, 0.8)';
                el.style.color = 'rgba(255, 251, 245, 1)';
                el.style.transform = 'translateY(-1px)';
                el.style.borderColor = 'rgba(255, 255, 255, 0.4)';
              });
              el.addEventListener('mouseleave', () => {
                el.style.background = 'rgba(160, 160, 160, 0.6)';
                el.style.color = 'rgba(255, 251, 245, 0.95)';
                el.style.transform = 'translateY(0)';
                el.style.borderColor = 'rgba(255, 255, 255, 0.2)';
              });
            }
          }, 0);
        } else {
          this.album.style.display = 'none';
          this.album.style.visibility = 'hidden';
        }
      }

      // Update metadata
      if (this.metadata) {
        const metadataItems: string[] = [];
        
        if (photo.data.camera) {
          const cameraIcon = this.getIconSVG('icon-camera');
          metadataItems.push(`<div class="lightbox-metadata-item">${cameraIcon}<span>${photo.data.camera}</span></div>`);
        }
        
        if (photo.data.settings) {
          // Parse settings to extract f-stop, shutter, ISO if possible
          const settingsIcon = this.getIconSVG('icon-aperture');
          metadataItems.push(`<div class="lightbox-metadata-item">${settingsIcon}<span>${photo.data.settings}</span></div>`);
        }

        const focalLengthDisplay = this.getRoundedFocalLength(photo.data.focalLength);
        if (focalLengthDisplay) {
          const focalIcon = this.getIconSVG('icon-focal');
          metadataItems.push(`<div class="lightbox-metadata-item">${focalIcon}<span>${focalLengthDisplay}</span></div>`);
        }
        
        if (photo.data.location && photo.data.location.trim()) {
          const locationTrimmed = photo.data.location.trim();
          const locationLower = locationTrimmed.toLowerCase();
          // Don't show location if it contains NaN or is exactly "na" (invalid coordinates)
          const hasInvalidCoords = locationLower.includes('nan') || locationLower === 'na';
          if (!hasInvalidCoords) {
            const locationIcon = this.getIconSVG('icon-location');
            metadataItems.push(`<div class="lightbox-metadata-item">${locationIcon}<span>${locationTrimmed}</span></div>`);
          }
        }
        
        if (metadataItems.length > 0) {
          this.metadata.innerHTML = metadataItems.join('');
          this.metadata.style.display = 'flex';
        } else {
          this.metadata.style.display = 'none';
        }
      }

      // Update counter (styled like film frame number) - moved inline with metadata
      if (this.counter) {
        this.counter.textContent = `${this.currentIndex + 1} / ${this.photos.length}`;
      }
    }

    private getIconSVG(iconId: string): string {
      const template = document.getElementById(iconId);
      if (!template) {
        console.warn(`Icon ${iconId} not found in DOM`);
        return '';
      }
      
      const clone = template.cloneNode(true) as SVGElement;
      clone.removeAttribute('id');
      clone.removeAttribute('style');
      clone.classList.add('photo-icon-inline');
      clone.setAttribute('width', '16');
      clone.setAttribute('height', '16');
      clone.setAttribute('fill', 'none');
      clone.setAttribute('stroke', 'currentColor');
      clone.style.display = 'inline-block';
      clone.style.verticalAlign = 'middle';
      clone.style.marginRight = '0.5rem';
      clone.style.color = 'currentColor';
      
      // Get the SVG content as a string
      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(clone);
      return svgString;
    }

    private preloadAdjacent() {
      const nextIndex = (this.currentIndex + 1) % this.photos.length;
      const prevIndex = (this.currentIndex - 1 + this.photos.length) % this.photos.length;

      const nextPhoto = this.photos[nextIndex];
      const prevPhoto = this.photos[prevIndex];

      if (nextPhoto) {
        const nextImg = new Image();
        nextImg.src = nextPhoto.url;
      }

      if (prevPhoto) {
        const prevImg = new Image();
        prevImg.src = prevPhoto.url;
      }
    }

    private getRoundedFocalLength(value?: number): string | null {
      if (typeof value !== 'number' || !Number.isFinite(value) || value <= 0) {
        return null;
      }

      if (value > 200) {
        const roundedHundreds = Math.round(value / 100) * 100;
        return `${Math.max(200, roundedHundreds)}mm`;
      }

      let closest = STANDARD_FOCAL_LENGTHS[0];
      let smallestDiff = Math.abs(value - closest);

      for (const candidate of STANDARD_FOCAL_LENGTHS) {
        const diff = Math.abs(value - candidate);
        if (diff < smallestDiff || (diff === smallestDiff && candidate > closest)) {
          closest = candidate;
          smallestDiff = diff;
        }
      }

      return `${closest}mm`;
    }
  }

  // Initialize lightbox after DOM is ready
  function initLightbox() {
    const photosDataElement = document.getElementById('photos-data');
    if (!photosDataElement) return;

    const photosData: Photo[] = JSON.parse(photosDataElement.textContent || '[]');
    if (photosData.length === 0) return;

    const lightbox = new PhotoLightbox(photosData);

    // Make lightbox accessible globally for photo cards and filter updates
    (window as any).photoLightbox = lightbox;
    
    // Store initial photos data for reference
    (window as any).allPhotosData = photosData;

    // Handle photo card clicks - find index in current filtered list
    document.addEventListener('click', (e) => {
      const card = (e.target as HTMLElement).closest('.photo-card[data-photo-id]');
      if (!card) return;

      e.preventDefault();
      
      // Trigger focus lock animation
      const viewfinder = card.querySelector('.viewfinder-corners');
      if (viewfinder) {
        viewfinder.classList.add('focus-locked');
        // Reset after animation
        setTimeout(() => {
          viewfinder.classList.remove('focus-locked');
        }, 1000);
      }
      
      const photoId = card.getAttribute('data-photo-id');
      if (!photoId) return;

      // Find index in the current filtered photos array (not the full list)
      const index = lightbox.photos.findIndex(p => p.id === photoId);
      if (index !== -1) {
        // Small delay to let the focus lock animation be seen before lightbox opens
        setTimeout(() => {
          lightbox.open(index);
        }, 200);
      }
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLightbox);
  } else {
    initLightbox();
  }
</script>

<script id="photos-data" type="application/json" set:html={JSON.stringify(photos.map(p => ({
  id: p.id,
  url: getPhotoUrl(p.data.filename),
  data: {
    title: p.data.title,
    filename: p.data.filename,
    album: p.data.album,
    albumTitle: p.data.albumTitle,
    tags: p.data.tags || [],
    camera: p.data.camera,
    settings: p.data.settings,
    focalLength: p.data.focalLength,
    location: p.data.location
  }
})))}></script>

<style is:global>
  .lightbox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .lightbox.active {
    opacity: 1;
    visibility: visible;
  }

  .lightbox-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(28, 25, 23, 0.95);
    backdrop-filter: blur(8px);
  }

  .shutter-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 10005;
    pointer-events: none;
    opacity: 0;
  }

  @keyframes shutterClick {
    0% { opacity: 0; }
    10% { opacity: 1; }
    40% { opacity: 1; }
    100% { opacity: 0; }
  }

  /* Film grain texture */
  .lightbox-backdrop::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0.03;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    pointer-events: none;
  }

  .lightbox-close {
    position: absolute;
    top: 2rem;
    right: 2rem;
    width: 48px;
    height: 48px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: var(--cream);
    font-size: 2rem;
    font-weight: 300;
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }

  .lightbox-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
  }

  .lightbox-content {
    position: relative;
    z-index: 10000;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    max-width: 1600px;
  }

  .lightbox-image-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0;
  }

  .lightbox-image {
    max-width: 100%;
    max-height: calc(100vh - 140px);
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 4px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: fadeInScale 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 1;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .lightbox-info {
    margin-top: 1.5rem;
    text-align: center;
    color: var(--cream);
    max-width: 95vw;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
  }

  .lightbox-metadata-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
    font-size: 0.875rem;
    color: rgba(255, 251, 245, 0.7);
    width: 100%;
  }

  .lightbox-metadata {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
    align-items: center;
  }

  .lightbox-metadata-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .lightbox-metadata-item .photo-icon-inline {
    width: 16px;
    height: 16px;
    opacity: 0.8;
  }

  .lightbox-metadata-item span {
    font-weight: 400;
    letter-spacing: 0.02em;
  }

  .lightbox-tags-and-album {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    align-items: center;
    width: 100%;
  }

  .lightbox-tags {
    display: contents !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  .lightbox-album {
    display: flex;
    align-items: center;
    justify-content: center;
    visibility: visible !important;
    opacity: 1 !important;
  }

  .lightbox-album-link {
    display: inline-flex !important;
    align-items: center;
    gap: 0.375rem;
  }

  .lightbox-album-link .photo-icon-inline {
    width: 14px;
    height: 14px;
    margin-right: 0;
  }

  .lightbox-tag {
    display: inline-block !important;
    font-size: 0.75rem;
    color: rgba(255, 251, 245, 0.95) !important;
    background: rgba(160, 160, 160, 0.6) !important;
    padding: 0.375rem 0.75rem;
    border-radius: 14px;
    font-weight: 400;
    letter-spacing: 0.02em;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
    border: 1px solid rgba(255, 255, 255, 0.2);
    white-space: nowrap;
    opacity: 1 !important;
    visibility: visible !important;
  }

  .lightbox-tag:hover {
    background: rgba(180, 180, 180, 0.8) !important;
    color: rgba(255, 251, 245, 1) !important;
    transform: translateY(-1px);
    border-color: rgba(255, 255, 255, 0.4);
  }

  .lightbox-tag:active {
    transform: translateY(0);
  }

  .lightbox-counter-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .lightbox-counter {
    font-size: 0.875rem;
    color: rgba(255, 251, 245, 0.7);
    font-weight: 400;
    letter-spacing: 0.05em;
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: inline-block;
  }

  .lightbox-slideshow-container {
    position: relative;
  }

  .lightbox-slideshow-btn {
    width: 40px;
    height: 40px;
    border: none;
    background: rgba(255, 255, 255, 0.05);
    color: rgba(255, 251, 245, 0.7);
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .lightbox-slideshow-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 251, 245, 0.9);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .lightbox-slideshow-btn.active {
    background: rgba(245, 158, 11, 0.2);
    color: rgba(245, 158, 11, 0.9);
    border-color: rgba(245, 158, 11, 0.4);
  }

  .lightbox-slideshow-icon {
    width: 18px;
    height: 18px;
    stroke: currentColor;
  }

  .lightbox-slideshow-dropdown {
    position: absolute;
    bottom: calc(100% + 0.5rem);
    right: 0;
    background: rgba(28, 25, 23, 0.98);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    padding: 0.25rem;
    min-width: 80px;
    z-index: 10002;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .slideshow-option {
    display: block;
    width: 100%;
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: none;
    color: rgba(255, 251, 245, 0.7);
    font-size: 0.875rem;
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 2px;
  }

  .slideshow-option:hover {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 251, 245, 0.9);
  }

  .slideshow-option.active {
    background: rgba(245, 158, 11, 0.2);
    color: rgba(245, 158, 11, 0.9);
  }

  .lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 56px;
    height: 56px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: var(--cream);
    font-size: 2.5rem;
    font-weight: 300;
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    line-height: 1;
  }

  .lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-50%) scale(1.1);
  }

  .lightbox-prev {
    left: 2rem;
  }

  .lightbox-next {
    right: 2rem;
  }

  @media (max-width: 768px) {
    .lightbox-close {
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
    }

    .lightbox-content {
      padding: 1rem;
    }

    .lightbox-image {
      max-height: calc(100vh - 180px);
    }

    .lightbox-nav {
      width: 44px;
      height: 44px;
      font-size: 2rem;
    }

    .lightbox-prev {
      left: 0.5rem;
    }

    .lightbox-next {
      right: 0.5rem;
    }

    .lightbox-info {
      margin-top: 1.5rem;
    }
  }

  @media (max-width: 480px) {
    .lightbox-nav {
      width: 36px;
      height: 36px;
      font-size: 1.5rem;
    }

    .lightbox-counter-controls {
      flex-wrap: wrap;
      justify-content: center;
    }

    .lightbox-slideshow-dropdown {
      right: auto;
      left: 50%;
      transform: translateX(-50%);
    }
  }
</style>

