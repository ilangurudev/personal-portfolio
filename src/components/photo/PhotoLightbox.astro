---
interface Props {
  photos: Array<{
    id: string;
    data: {
      title: string;
      filename: string;
      tags?: string[];
    };
  }>;
  initialIndex?: number;
}

const { photos, initialIndex = 0 } = Astro.props;
---

<div id="photo-lightbox" class="lightbox" style="display: none;">
  <div class="lightbox-backdrop"></div>
  <button class="lightbox-close" aria-label="Close lightbox">×</button>
  
  <div class="lightbox-content">
    <button class="lightbox-nav lightbox-prev" aria-label="Previous photo">‹</button>
    <div class="lightbox-image-container">
      <img class="lightbox-image" src="" alt="" />
      <div class="lightbox-info">
        <div class="lightbox-tags"></div>
        <div class="lightbox-counter"></div>
      </div>
    </div>
    <button class="lightbox-nav lightbox-next" aria-label="Next photo">›</button>
  </div>
</div>

<script>
  interface Photo {
    id: string;
    data: {
      title: string;
      filename: string;
      tags?: string[];
    };
  }

  class PhotoLightbox {
    private lightbox: HTMLElement | null;
    private image: HTMLImageElement | null;
    private tags: HTMLElement | null;
    private counter: HTMLElement | null;
    private photos: Photo[];
    private currentIndex: number;
    private isOpen: boolean = false;

    constructor(photos: Photo[]) {
      this.photos = photos;
      this.currentIndex = 0;
      this.lightbox = document.getElementById('photo-lightbox');
      this.image = this.lightbox?.querySelector('.lightbox-image') as HTMLImageElement;
      this.tags = this.lightbox?.querySelector('.lightbox-tags') as HTMLElement;
      this.counter = this.lightbox?.querySelector('.lightbox-counter') as HTMLElement;

      this.init();
    }

    private init() {
      if (!this.lightbox) return;

      // Close button
      const closeBtn = this.lightbox.querySelector('.lightbox-close');
      closeBtn?.addEventListener('click', () => this.close());

      // Backdrop click
      const backdrop = this.lightbox.querySelector('.lightbox-backdrop');
      backdrop?.addEventListener('click', () => this.close());

      // Navigation buttons
      const prevBtn = this.lightbox.querySelector('.lightbox-prev');
      const nextBtn = this.lightbox.querySelector('.lightbox-next');
      prevBtn?.addEventListener('click', () => this.prev());
      nextBtn?.addEventListener('click', () => this.next());

      // Keyboard navigation
      document.addEventListener('keydown', (e) => this.handleKeydown(e));

      // Prevent body scroll when open
      this.lightbox.addEventListener('transitionend', () => {
        if (this.isOpen) {
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = '';
        }
      });
    }

    private handleKeydown(e: KeyboardEvent) {
      if (!this.isOpen) return;

      switch (e.key) {
        case 'Escape':
          this.close();
          break;
        case 'ArrowLeft':
          this.prev();
          break;
        case 'ArrowRight':
          this.next();
          break;
      }
    }

    public open(index: number) {
      if (index < 0 || index >= this.photos.length) return;
      
      this.currentIndex = index;
      this.isOpen = true;
      this.updateImage();
      
      if (this.lightbox) {
        this.lightbox.style.display = 'flex';
        // Trigger reflow for animation
        requestAnimationFrame(() => {
          this.lightbox?.classList.add('active');
        });
      }
    }

    public close() {
      this.isOpen = false;
      if (this.lightbox) {
        this.lightbox.classList.remove('active');
        // Hide after animation
        setTimeout(() => {
          if (this.lightbox && !this.isOpen) {
            this.lightbox.style.display = 'none';
          }
        }, 300);
      }
      document.body.style.overflow = '';
    }

    public next() {
      const nextIndex = (this.currentIndex + 1) % this.photos.length;
      this.open(nextIndex);
    }

    public prev() {
      const prevIndex = (this.currentIndex - 1 + this.photos.length) % this.photos.length;
      this.open(prevIndex);
    }

    private updateImage() {
      const photo = this.photos[this.currentIndex];
      if (!photo || !this.image) return;

      // Preload next and previous images
      this.preloadAdjacent();

      // Update current image
      this.image.src = `/photos/${photo.data.filename}`;
      this.image.alt = photo.data.title;

      // Update tags
      if (this.tags) {
        if (photo.data.tags && Array.isArray(photo.data.tags) && photo.data.tags.length > 0) {
          const tagsHTML = photo.data.tags
            .map(tag => {
              const encodedTag = encodeURIComponent(tag);
              return `<span class="lightbox-tag" data-tag="${encodedTag}" style="display: inline-block; font-size: 0.75rem; color: rgba(255, 251, 245, 0.95); background: rgba(160, 160, 160, 0.6); padding: 0.375rem 0.75rem; border-radius: 14px; font-weight: 400; letter-spacing: 0.02em; cursor: pointer; transition: all 0.2s ease; user-select: none; border: 1px solid rgba(255, 255, 255, 0.2); white-space: nowrap; opacity: 1; visibility: visible;">#${tag.toLowerCase()}</span>`;
            })
            .join('');
          this.tags.innerHTML = tagsHTML;
          this.tags.style.display = 'flex';
          this.tags.style.visibility = 'visible';
          
          // Add click handlers to tags
          setTimeout(() => {
            this.tags?.querySelectorAll('.lightbox-tag').forEach(tagEl => {
              const el = tagEl as HTMLElement;
              el.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                const tag = el.getAttribute('data-tag');
                if (tag) {
                  window.location.href = `/photo/tag/${tag}`;
                }
              });
              el.addEventListener('mouseenter', () => {
                el.style.background = 'rgba(180, 180, 180, 0.8)';
                el.style.color = 'rgba(255, 251, 245, 1)';
                el.style.transform = 'translateY(-1px)';
                el.style.borderColor = 'rgba(255, 255, 255, 0.4)';
              });
              el.addEventListener('mouseleave', () => {
                el.style.background = 'rgba(160, 160, 160, 0.6)';
                el.style.color = 'rgba(255, 251, 245, 0.95)';
                el.style.transform = 'translateY(0)';
                el.style.borderColor = 'rgba(255, 255, 255, 0.2)';
              });
            });
          }, 0);
        } else {
          this.tags.style.display = 'none';
          this.tags.style.visibility = 'hidden';
        }
      }

      // Update counter
      if (this.counter) {
        this.counter.textContent = `${this.currentIndex + 1} / ${this.photos.length}`;
      }
    }

    private preloadAdjacent() {
      const nextIndex = (this.currentIndex + 1) % this.photos.length;
      const prevIndex = (this.currentIndex - 1 + this.photos.length) % this.photos.length;

      const nextPhoto = this.photos[nextIndex];
      const prevPhoto = this.photos[prevIndex];

      if (nextPhoto) {
        const nextImg = new Image();
        nextImg.src = `/photos/${nextPhoto.data.filename}`;
      }

      if (prevPhoto) {
        const prevImg = new Image();
        prevImg.src = `/photos/${prevPhoto.data.filename}`;
      }
    }
  }

  // Initialize lightbox after DOM is ready
  function initLightbox() {
    const photosDataElement = document.getElementById('photos-data');
    if (!photosDataElement) return;

    const photosData: Photo[] = JSON.parse(photosDataElement.textContent || '[]');
    if (photosData.length === 0) return;

    const lightbox = new PhotoLightbox(photosData);

    // Make lightbox accessible globally for photo cards
    (window as any).photoLightbox = lightbox;

    // Handle photo card clicks
    document.addEventListener('click', (e) => {
      const card = (e.target as HTMLElement).closest('.photo-card[data-photo-id]');
      if (!card) return;

      e.preventDefault();
      const photoId = card.getAttribute('data-photo-id');
      if (!photoId) return;

      const index = photosData.findIndex(p => p.id === photoId);
      if (index !== -1) {
        lightbox.open(index);
      }
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLightbox);
  } else {
    initLightbox();
  }
</script>

<script id="photos-data" type="application/json" set:html={JSON.stringify(photos.map(p => ({
  id: p.id,
  data: {
    title: p.data.title,
    filename: p.data.filename,
    tags: p.data.tags || []
  }
})))}></script>

<style is:global>
  .lightbox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .lightbox.active {
    opacity: 1;
    visibility: visible;
  }

  .lightbox-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(28, 25, 23, 0.95);
    backdrop-filter: blur(8px);
  }

  .lightbox-close {
    position: absolute;
    top: 2rem;
    right: 2rem;
    width: 48px;
    height: 48px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: var(--cream);
    font-size: 2rem;
    font-weight: 300;
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }

  .lightbox-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
  }

  .lightbox-content {
    position: relative;
    z-index: 10000;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    max-width: 1600px;
  }

  .lightbox-image-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .lightbox-image {
    max-width: 100%;
    max-height: calc(100vh - 200px);
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 4px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: fadeInScale 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .lightbox-info {
    margin-top: 2rem;
    text-align: center;
    color: var(--cream);
    max-width: 800px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .lightbox-tags {
    display: flex !important;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    margin-bottom: 1rem;
    visibility: visible !important;
    opacity: 1 !important;
    min-height: 1.5rem;
  }

  .lightbox-tag {
    display: inline-block !important;
    font-size: 0.75rem;
    color: rgba(255, 251, 245, 0.95) !important;
    background: rgba(160, 160, 160, 0.6) !important;
    padding: 0.375rem 0.75rem;
    border-radius: 14px;
    font-weight: 400;
    letter-spacing: 0.02em;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
    border: 1px solid rgba(255, 255, 255, 0.2);
    white-space: nowrap;
    opacity: 1 !important;
    visibility: visible !important;
  }

  .lightbox-tag:hover {
    background: rgba(180, 180, 180, 0.8) !important;
    color: rgba(255, 251, 245, 1) !important;
    transform: translateY(-1px);
    border-color: rgba(255, 255, 255, 0.4);
  }

  .lightbox-tag:active {
    transform: translateY(0);
  }

  .lightbox-counter {
    font-size: 0.875rem;
    color: rgba(255, 251, 245, 0.6);
    font-weight: 400;
    letter-spacing: 0.05em;
  }

  .lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 56px;
    height: 56px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: var(--cream);
    font-size: 2.5rem;
    font-weight: 300;
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    line-height: 1;
  }

  .lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-50%) scale(1.1);
  }

  .lightbox-prev {
    left: 2rem;
  }

  .lightbox-next {
    right: 2rem;
  }

  @media (max-width: 768px) {
    .lightbox-close {
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
    }

    .lightbox-content {
      padding: 1rem;
    }

    .lightbox-image {
      max-height: calc(100vh - 180px);
    }

    .lightbox-nav {
      width: 44px;
      height: 44px;
      font-size: 2rem;
    }

    .lightbox-prev {
      left: 0.5rem;
    }

    .lightbox-next {
      right: 0.5rem;
    }

    .lightbox-info {
      margin-top: 1.5rem;
    }
  }

  @media (max-width: 480px) {
    .lightbox-nav {
      width: 36px;
      height: 36px;
      font-size: 1.5rem;
    }

  }
</style>

